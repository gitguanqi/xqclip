(function(i,t){"object"==typeof module&&"object"==typeof module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t()):"function"==typeof define&&define.cmd?define(function(i,e,o){o.exports=t()}):i.xqclip=t()})(this,function(){function i(i){let t={box:i.box||".clip-box",boxWin:i.boxWin||400,boxHei:i.boxHei||400,areaWin:i.areaWin||100,areaHei:i.areaHei||100,pre:i.pre,url:i.url||"",scale:i.scale||1,showPos:null==i.showPos||i.showPos,scaleImg:null==i.scaleImg||i.scaleImg};this.pre=null,""!=t.box?".clip-box"!=t.box?""!=t.url?(t.pre&&(t.pre=i.pre,this.pre=document.querySelector(t.pre)),"IMG"===this.pre.nodeName?(this.box=document.querySelector(t.box),this.box.style.width=t.boxWin+"px",this.box.style.height=t.boxHei+"px",this.boxWin=t.boxWin,this.boxHei=t.boxHei,this.areaWin=t.areaWin*t.scale,this.areaHei=t.areaHei,this.imgSrc=t.url,this.scale=t.scale,this.showPos=t.showPos,this.scaleImg=t.scaleImg,this.scaleMin=64,this.scaleMinWin=this.scaleMin*this.scale,this.scaleMinHei=this.scaleMin,this.clipBoxInfo={win:0,hei:0,left:0,top:0},this.clipAreaInfo={win:0,hei:0,left:0,top:0},this.imgInfo={elem:null,x:0,y:0,win:0,hei:0},this.clipImg=null,this.clipCxt=null,this.tempCanvas=null,this.tempCxt=null,this.tempData=null,this.tempInfo=null,this.clipScale=0,this.clipBox=null,this.clipScaleBtn=null,this.clipArea=null,this.clipShadowTop=null,this.clipShadowRight=null,this.clipShadowBottom=null,this.clipShadowLeft=null,this.isMobile=null,this.eventName={start:"",move:"",end:""},this.checkMobile(),this.initElem()):console.error("pre must is image element!")):console.error("url is not null!"):console.error("box class name is not allow!"):console.error("box class name is not null!")}return i.prototype.checkMobile=function(){let i="touchstart"in document||document.documentElement.clientWidth<=768||document.body.clientWidth<=768;this.isMobile=i,this.eventName=this.isMobile?{start:"touchstart",move:"touchmove",end:"touchend"}:{start:"mousedown",move:"mousemove",end:"mouseup"},window.onresize=this.checkMobile},i.prototype.initElem=function(){this.box.innerHTML='<div class="clip-box clip-bg">\n            <canvas id="clip-img" class="clip-bg"></canvas>\n            <div class="clip-img-shadow clip-img-shadow-top"></div>\n            <div class="clip-img-shadow clip-img-shadow-right"></div>\n            <div class="clip-img-shadow clip-img-shadow-bottom"></div>\n            <div class="clip-img-shadow clip-img-shadow-left"></div>\n            <div class="clip-img-area no-pos" data-pos="pos(0,0)"  data-size="wh(0,0)">\n                <span></span>\n                <span></span>\n                <span></span>\n                <span></span>\n                <span></span>\n                <span></span>\n                <span></span>\n                <span></span>\n                <span></span>\n                <small class="clip-img-scale"></small>\n            </div>\n            <canvas id="clip-temp"></canvas>\n        </div>',this.getElem()},i.prototype.getElem=function(){this.clipBox=document.querySelector(".clip-box"),this.clipScaleBtn=document.querySelector(".clip-img-scale"),this.clipArea=document.querySelector(".clip-img-area"),this.clipShadowTop=document.querySelector(".clip-img-shadow-top"),this.clipShadowRight=document.querySelector(".clip-img-shadow-right"),this.clipShadowBottom=document.querySelector(".clip-img-shadow-bottom"),this.clipShadowLeft=document.querySelector(".clip-img-shadow-left"),this.clipImg=document.getElementById("clip-img"),this.clipCxt=this.clipImg.getContext("2d"),this.clipImg.width=this.boxWin,this.clipImg.height=this.boxHei,this.tempCanvas=document.getElementById("clip-temp"),this.tempCxt=this.tempCanvas.getContext("2d"),this.loadImg(),this.calcAreaElem()},i.prototype.loadImg=function(){let i=this,t=new Image;t.src=i.imgSrc,t.onload=function(){let e=0,o=0,l=0,s=0,n=t.width/t.height;1==n?(e=i.boxWin/2,o=i.boxHei/2,l=(i.boxWin-e)/2):(e=i.boxWin,o=i.boxHei/n,l=0),s=(i.boxHei-o)/2,i.imgInfo={elem:t,x:l,y:s,win:e,hei:o},i.drawImg(i.imgInfo)},this.scaleImg&&this.addWheel()},i.prototype.addWheel=function(){let i=this,t=1;i.clipBox.addEventListener("wheel",function(e){let o=!(e.deltaY>0);o&&t<3&&(t+=.2),!o&&t>.4&&(t-=.2);let l=i.imgInfo.elem.width/i.imgInfo.elem.height;1==l?(imgWin=i.boxWin/2*t,imgHei=i.boxHei/2*t,imgX=(i.boxWin-imgWin)/2*t):(imgWin=i.boxWin*t,imgHei=i.boxHei/l*t,imgX=0),imgY=(i.boxHei-imgHei)/2,i.imgInfo={elem:i.imgInfo.elem,x:imgX,y:imgY,win:imgWin,hei:imgHei},i.drawImg(i.imgInfo)})},i.prototype.drawImg=function(i){this.clipImg.width=this.boxWin,this.clipImg.height=this.boxHei,this.clipCxt.drawImage(i.elem,i.x,i.y,i.win,i.hei)},i.prototype.replaceImg=function(i){return i?""==i?(console.error("url is not null!"),!1):(this.clipImg.width=this.boxWin,this.clipImg.height=this.boxHei,this.imgSrc=i,void this.loadImg()):(console.error("url is must!"),!1)},i.prototype.calcAreaElem=function(){this.clipArea.style.width=this.areaWin+"px",this.clipArea.style.height=this.areaHei+"px",this.clipArea.style.left=(this.boxWin-this.areaWin)/2+"px",this.clipArea.style.top=(this.boxHei-this.areaHei)/2+"px",this.showPos&&this.clipArea.classList.remove("no-pos"),this.calcAreaPos(),this.initShadowElem(),this.clipBoxMove(),this.clipAreaScale()},i.prototype.calcAreaPos=function(){this.clipBoxInfo={win:this.clipBox.offsetWidth,hei:this.clipBox.offsetHeight,left:this.clipBox.offsetLeft,top:this.clipBox.offsetTop},this.clipAreaInfo={win:this.clipArea.offsetWidth,hei:this.clipArea.offsetHeight,left:this.clipArea.offsetLeft,top:this.clipArea.offsetTop}},i.prototype.initShadowElem=function(){this.clipShadowTop.style.width=this.areaWin+"px",this.clipShadowTop.style.height=this.clipAreaInfo.top+"px",this.clipShadowTop.style.left=this.clipAreaInfo.left+"px",this.clipShadowTop.style.top=0,this.clipShadowRight.style.width=this.clipAreaInfo.left+"px",this.clipShadowRight.style.height=this.clipBoxInfo.hei+"px",this.clipShadowRight.style.right=0,this.clipShadowRight.style.top=0,this.clipShadowBottom.style.width=this.areaWin+"px",this.clipShadowBottom.style.height=this.clipAreaInfo.top+"px",this.clipShadowBottom.style.left=this.clipAreaInfo.left+"px",this.clipShadowBottom.style.bottom=0,this.clipShadowLeft.style.width=this.clipAreaInfo.left+"px",this.clipShadowLeft.style.height=this.clipBoxInfo.hei+"px",this.clipShadowLeft.style.left=0,this.clipShadowLeft.style.top=0},i.prototype.clipBoxMove=function(){let i=this;i.clipBox.addEventListener(i.eventName.start,function(t){let e=t.target.className;if("clip-img-scale"==e)return!1;i.clipBox[`on${i.eventName.move}`]=function(t){let e={x:t.clientX,y:t.clientY};i.calcAreaPos();let o=e.x-i.clipBoxInfo.left,l=e.y-i.clipBoxInfo.top,s=o-i.clipAreaInfo.win/2,n=l-i.clipAreaInfo.win/2;s<0&&(s=0),s>i.clipBoxInfo.win-i.clipAreaInfo.win&&(s=i.clipBoxInfo.win-i.clipAreaInfo.win),n<0&&(n=0),n>i.clipBoxInfo.hei-i.clipAreaInfo.hei&&(n=i.clipBoxInfo.hei-i.clipAreaInfo.hei),i.clipArea.style.left=s+"px",i.clipArea.style.top=n+"px",i.calcShadowElem(),i.getAreaData()}},!1),i.clipBox.addEventListener(i.eventName.end,function(){i.clipBox[`on${i.eventName.move}`]=null},!1)},i.prototype.clipAreaScale=function(){let i=this;i.clipScaleBtn.addEventListener(i.eventName.start,function(t){let e={x:t.clientX,y:t.clientY};i.clipBox[`on${i.eventName.move}`]=function(t){let o={x:t.clientX,y:t.clientY},l={width:o.x-e.x,height:o.y-e.y},s={win:l.width+i.clipAreaInfo.win,hei:l.height+i.clipAreaInfo.hei};1==i.scale&&(s.win=s.win,s.hei=s.win),i.scale>1&&(s.win=s.win*i.scale,s.hei=s.hei),s.win>=(i.clipBoxInfo.win-i.clipAreaInfo.left)*i.scale&&(s.win=i.clipBoxInfo.win-i.clipAreaInfo.left),s.hei>=(i.clipBoxInfo.hei-i.clipAreaInfo.top)*i.scale&&(s.hei=i.clipBoxInfo.hei-i.clipAreaInfo.top),s.win<=i.scaleMinWin&&(s.win=i.scaleMinWin),s.hei<=i.scaleMinHei&&(s.hei=i.scaleMinHei),i.clipArea.style.width=s.win+"px",i.clipArea.style.height=s.hei+"px",i.calcAreaPos(),i.changeShadowElem(s.win),i.calcShadowElem(),i.getAreaData()}},!1),i.clipScaleBtn.addEventListener(i.eventName.end,function(){i.clipBox[`on${i.eventName.move}`]=null})},i.prototype.calcShadowElem=function(){this.clipShadowTop.style.height=this.clipAreaInfo.top+"px",this.clipShadowTop.style.left=this.clipAreaInfo.left+"px",this.clipShadowRight.style.width=this.clipBoxInfo.win-this.clipAreaInfo.left-this.clipAreaInfo.win+"px",this.clipShadowBottom.style.height=this.clipBoxInfo.hei-this.clipAreaInfo.top-this.clipAreaInfo.hei+"px",this.clipShadowBottom.style.left=this.clipAreaInfo.left+"px",this.clipShadowLeft.style.width=this.clipAreaInfo.left+"px"},i.prototype.changeShadowElem=function(i){this.clipShadowTop.style.width=i+"px",this.clipShadowTop.style.height=this.clipAreaInfo.top+"px",this.clipShadowRight.style.width=this.clipBoxInfo.win-i+"px",this.clipShadowRight.style.height=this.clipBoxInfo.hei+"px",this.clipShadowBottom.style.width=i+"px",this.clipShadowBottom.style.height=this.clipBoxInfo.hei-this.clipAreaInfo.top-i+"px",this.clipShadowLeft.style.width=this.clipBoxInfo.win-i+"px"},i.prototype.getAreaData=function(){this.tempCanvas.width=this.clipAreaInfo.win,this.tempCanvas.height=this.clipAreaInfo.hei,this.tempCanvas.style.overflow="hidden",this.clipArea.setAttribute("data-pos",`pos(${this.clipAreaInfo.left},${this.clipAreaInfo.top})`),this.clipArea.setAttribute("data-size",`wh(${this.clipAreaInfo.win},${this.clipAreaInfo.hei})`),this.tempData=this.clipCxt.getImageData(this.clipAreaInfo.left,this.clipAreaInfo.top,this.clipAreaInfo.win,this.clipAreaInfo.hei),this.tempCxt.putImageData(this.tempData,0,0),this.saveImgData()},i.prototype.saveImgData=function(){this.tempInfo={base64:this.tempCanvas.toDataURL("image/jpg")},this.tempInfo.blob=window.URL.createObjectURL(this.dataToBlob(this.tempInfo.base64)),this.tempInfo.file=this.dataToFile(this.tempInfo.base64),this.pre.style.width=this.clipAreaInfo.win+"px",this.pre.style.height=this.clipAreaInfo.hei+"px",this.pre.style.overflow="hidden",this.pre.src=this.tempInfo.base64},i.prototype.getCanvasImgData=function(){return this.tempInfo},i.prototype.dataToBlob=function(i){var t;t=i.split(",")[0].indexOf("base64")>=0?atob(i.split(",")[1]):unescape(i.split(",")[1]);for(var e=i.split(",")[0].split(":")[1].split(";")[0],o=new Uint8Array(t.length),l=0;l<t.length;l++)o[l]=t.charCodeAt(l);var s=new Blob([o],{type:e});return s},i.prototype.dataToFile=function(i,t){let e=i.split(","),o=e[0].match(/:(.*?);/)[1];t||(t=Date.parse(new Date)+".jpg");let l=atob(e[1]),s=l.length,n=new Uint8Array(s);for(;s--;)n[s]=l.charCodeAt(s);return new File([n],t,{type:o})},i});